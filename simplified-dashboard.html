<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Racing Dashboard</title>
  <style>
    /* Basic Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header */
    header {
      background: linear-gradient(to right, #1e40af, #1e3a8a);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .title {
      font-size: 24px;
      font-weight: bold;
    }
    
    .admin-badge {
      background-color: #3b82f6;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      margin-left: 10px;
      cursor: pointer;
    }
    
    .admin-banner {
      background-color: #fbbf24;
      color: #92400e;
      text-align: center;
      padding: 8px;
      margin-top: 10px;
      display: none;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    
    .tab.active {
      background-color: white;
      border: 1px solid #ddd;
      border-bottom: none;
      font-weight: bold;
    }
    
    /* Content */
    .content {
      background-color: white;
      border-radius: 5px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    /* Buttons */
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }
    
    .btn-danger {
      background-color: #ef4444;
      color: white;
    }
    
    .btn-success {
      background-color: #10b981;
      color: white;
    }
    
    .btn-warning {
      background-color: #f59e0b;
      color: white;
    }
    
    /* Forms */
    .form-panel {
      background-color: #f0f9ff;
      border-left: 4px solid #3b82f6;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: none;
    }
    
    .form-row {
      margin-bottom: 15px;
    }
    
    .form-grid {
      display: grid;
      grid-gap: 15px;
    }
    
    @media (min-width: 768px) {
      .form-grid-2 {
        grid-template-columns: 1fr 1fr;
      }
      
      .form-grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Race Cards */
    .race-grid {
      display: grid;
      grid-gap: 20px;
    }
    
    @media (min-width: 768px) {
      .race-grid {
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      }
    }
    
    .race-card {
      background-color: white;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: 1px solid #ddd;
    }
    
    .race-header {
      background: linear-gradient(to right, #1e40af, #1e3a8a);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
    }
    
    .race-content {
      padding: 15px;
    }
    
    /* Utilities */
    .text-center {
      text-align: center;
    }
    
    .mt-20 {
      margin-top: 20px;
    }
    
    .mb-20 {
      margin-bottom: 20px;
    }
    
    .flex {
      display: flex;
    }
    
    .justify-end {
      justify-content: flex-end;
    }
    
    .space-x-2 > * + * {
      margin-left: 8px;
    }
    
    /* Driver Circle */
    .driver-circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      color: white;
      font-weight: bold;
    }
    
    /* Progress bar */
    .progress-container {
      background-color: #e5e7eb;
      border-radius: 9999px;
      height: 8px;
      width: 100%;
      margin-bottom: 5px;
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 9999px;
    }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-green {
      background-color: #dcfce7;
      color: #166534;
    }
    
    .badge-red {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    /* Modals */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .modal {
      background-color: white;
      border-radius: 5px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      margin-bottom: 15px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
    }
    
    /* Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    /* Status bar */
    .status-bar {
      background-color: #eff6ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Info box */
    .info-box {
      background-color: #eff6ff;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      color: #1e40af;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
  </div>

  <header>
    <div class="container">
      <div class="header-content">
        <h1 class="title">Racing Dashboard</h1>
        <div>
          <span id="driversCount">0 Drivers</span>
          <button id="loginButton" class="admin-badge">Admin Login</button>
          <button id="logoutButton" class="admin-badge hidden">Admin Logout</button>
        </div>
      </div>
      <div id="adminBanner" class="admin-banner">
        Admin Mode - You can add, edit and delete content for all viewers
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Status Bar -->
    <div class="status-bar">
      <div>
        <span>Last updated: <span id="lastUpdateTime">Just now</span></span>
      </div>
      <div>
        <button id="refreshButton" class="btn-primary">Refresh Now</button>
        <label>
          <input type="checkbox" id="autoRefreshToggle" checked>
          Auto-refresh
        </label>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <div id="driversTab" class="tab active">Drivers</div>
      <div id="racesTab" class="tab">Races</div>
    </div>
    
    <!-- Content -->
    <div class="content">
      <!-- Drivers Content -->
      <div id="driversContent" class="content-section active">
        <div class="section-header">
          <h2>Driver Standings</h2>
          <button id="addDriverButton" class="btn-primary hidden">Add Driver</button>
        </div>
        
        <!-- Add Driver Form -->
        <div id="addDriverForm" class="form-panel">
          <h3 class="mb-20">New Driver Registration</h3>
          <div class="form-grid form-grid-2">
            <div class="form-row">
              <label for="newDriverName">Driver Name*</label>
              <input type="text" id="newDriverName" placeholder="Driver Name">
            </div>
            <div class="form-row">
              <label for="newDriverNumber">Car Number*</label>
              <input type="number" id="newDriverNumber" placeholder="Car Number">
            </div>
          </div>
          <div class="form-grid form-grid-3">
            <div class="form-row">
              <label for="newDriverWins">Wins</label>
              <input type="number" id="newDriverWins" value="0" placeholder="0">
            </div>
            <div class="form-row">
              <label for="newDriverLosses">Losses</label>
              <input type="number" id="newDriverLosses" value="0" placeholder="0">
            </div>
            <div class="form-row">
              <label for="newDriverRaces">Races</label>
              <input type="number" id="newDriverRaces" value="0" placeholder="0">
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <button id="cancelAddDriverButton" class="btn-danger">Cancel</button>
            <button id="saveDriverButton" class="btn-primary">Save Driver</button>
          </div>
        </div>
        
        <!-- Drivers Table -->
        <table id="driversTable">
          <thead>
            <tr>
              <th>Car #</th>
              <th id="sortByName">Driver</th>
              <th id="sortByRaces">Races</th>
              <th id="sortByWins">Wins</th>
              <th id="sortByLosses">Losses</th>
              <th>Win %</th>
              <th id="actionsColumn" class="hidden">Actions</th>
            </tr>
          </thead>
          <tbody id="driversTableBody"></tbody>
        </table>
        
        <!-- View Mode Info -->
        <div id="viewModeInfo" class="info-box">
          View Mode: Login as Admin to make changes
        </div>
      </div>
      
      <!-- Races Content -->
      <div id="racesContent" class="content-section hidden">
        <div class="section-header">
          <h2>Race Events</h2>
          <button id="addRaceButton" class="btn-primary hidden">Add Race</button>
        </div>
        
        <!-- Add Race Form -->
        <div id="addRaceForm" class="form-panel">
          <h3 class="mb-20">New Race Event</h3>
          <div class="form-grid form-grid-2">
            <div class="form-row">
              <label for="newRaceName">Race Name*</label>
              <input type="text" id="newRaceName" placeholder="Race Name">
            </div>
            <div class="form-row">
              <label for="newRaceDate">Date*</label>
              <input type="date" id="newRaceDate">
            </div>
          </div>
          
          <!-- Driver Participation -->
          <div class="form-row">
            <label>Driver Participation</label>
            <div id="driverParticipationContainer" class="form-grid"></div>
          </div>
          
          <!-- Driver Positions -->
          <div class="form-row">
            <label>Driver Positions</label>
            <div id="driverPositionsContainer" class="form-grid"></div>
          </div>
          
          <div class="flex justify-end space-x-2">
            <button id="cancelAddRaceButton" class="btn-danger">Cancel</button>
            <button id="saveRaceButton" class="btn-primary">Save Race</button>
          </div>
        </div>
        
        <!-- Race Cards -->
        <div id="racesList" class="race-grid"></div>
        
        <!-- View Mode Info -->
        <div id="raceViewModeInfo" class="info-box">
          View Mode: Login as Admin to make changes
        </div>
      </div>
    </div>
  </div>
  
  <!-- Login Modal -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Admin Login</h3>
      </div>
      <div class="modal-body">
        <p class="mb-20">Enter the admin password to access editing features</p>
        <div class="form-row">
          <label for="passwordInput">Password</label>
          <input type="password" id="passwordInput">
          <p id="loginError" class="text-danger hidden"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelLoginButton" class="btn-danger">Cancel</button>
        <button id="confirmLoginButton" class="btn-primary">Login</button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Confirm Deletion</h3>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this <span id="deleteItemType">item</span>? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button id="cancelDeleteButton" class="btn-danger">Cancel</button>
        <button id="confirmDeleteButton" class="btn-primary">Yes, Delete</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Driver Modal -->
  <div id="editDriverModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Driver</h3>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label for="editDriverName">Name</label>
          <input type="text" id="editDriverName">
        </div>
        <div class="form-row">
          <label for="editDriverNumber">Car Number</label>
          <input type="number" id="editDriverNumber">
        </div>
        <div class="form-row">
          <label for="editDriverWins">Wins</label>
          <input type="number" id="editDriverWins">
        </div>
        <div class="form-row">
          <label for="editDriverLosses">Losses</label>
          <input type="number" id="editDriverLosses">
        </div>
        <div class="form-row">
          <label for="editDriverRaces">Races</label>
          <input type="number" id="editDriverRaces">
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelEditButton" class="btn-danger">Cancel</button>
        <button id="saveEditButton" class="btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // ===============================================
    // Default data
    // ===============================================
    const DEFAULT_DRIVERS = [
      { id: 1, name: 'Max Speed', carNumber: 42, wins: 5, losses: 1, races: 6 },
      { id: 2, name: 'Lara Fast', carNumber: 27, wins: 4, losses: 2, races: 6 },
      { id: 3, name: 'Jack Turbo', carNumber: 83, wins: 2, losses: 4, races: 6 }
    ];

    const DEFAULT_RACES = [
      {
        id: 1, name: 'Season Opener', date: '2024-03-01',
        results: [
          { driverId: 1, position: 1 },
          { driverId: 2, position: 2 },
          { driverId: 3, position: 3 }
        ]
      },
      {
        id: 2, name: 'Mountain Challenge', date: '2024-03-15',
        results: [
          { driverId: 2, position: 1 },
          { driverId: 1, position: 2 },
          { driverId: 3, position: 4 }
        ]
      }
    ];

    // ===============================================
    // State management
    // ===============================================
    let drivers = [];
    let races = [];
    let isAdmin = false;
    let autoRefresh = true;
    let refreshInterval;
    let lastUpdate = Date.now();
    let sortConfig = { key: 'wins', direction: 'desc' };
    let editingDriverId = null;
    let deleteItem = { id: null, type: null };
    let participation = {};

    // ===============================================
    // Initialization
    // ===============================================
    document.addEventListener('DOMContentLoaded', () => {
      try {
        setupEventListeners();
        loadData();
        startAutoRefresh();
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        alert('There was an error initializing the dashboard. Please check the console for details.');
        hideLoading();
      }
    });

    function setupEventListeners() {
      // Tab switching
      document.getElementById('driversTab').addEventListener('click', () => switchTab('drivers'));
      document.getElementById('racesTab').addEventListener('click', () => switchTab('races'));
      
      // Auth buttons
      document.getElementById('loginButton').addEventListener('click', showLoginModal);
      document.getElementById('logoutButton').addEventListener('click', handleLogout);
      document.getElementById('confirmLoginButton').addEventListener('click', handleLogin);
      document.getElementById('cancelLoginButton').addEventListener('click', hideLoginModal);
      
      // Password input enter key
      document.getElementById('passwordInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      
      // Refresh controls
      document.getElementById('refreshButton').addEventListener('click', refreshData);
      document.getElementById('autoRefreshToggle').addEventListener('change', toggleAutoRefresh);
      
      // Driver form controls
      document.getElementById('addDriverButton').addEventListener('click', toggleAddDriverForm);
      document.getElementById('cancelAddDriverButton').addEventListener('click', toggleAddDriverForm);
      document.getElementById('saveDriverButton').addEventListener('click', addDriver);
      
      // Race form controls
      document.getElementById('addRaceButton').addEventListener('click', toggleAddRaceForm);
      document.getElementById('cancelAddRaceButton').addEventListener('click', toggleAddRaceForm);
      document.getElementById('saveRaceButton').addEventListener('click', addRace);
      
      // Edit driver modal
      document.getElementById('cancelEditButton').addEventListener('click', hideEditDriverModal);
      document.getElementById('saveEditButton').addEventListener('click', saveDriverEdit);
      
      // Delete confirmation modal
      document.getElementById('cancelDeleteButton').addEventListener('click', hideDeleteConfirmModal);
      document.getElementById('confirmDeleteButton').addEventListener('click', confirmDelete);
      
      // Sorting
      document.getElementById('sortByName').addEventListener('click', () => requestSort('name'));
      document.getElementById('sortByRaces').addEventListener('click', () => requestSort('races'));
      document.getElementById('sortByWins').addEventListener('click', () => requestSort('wins'));
      document.getElementById('sortByLosses').addEventListener('click', () => requestSort('losses'));
    }

    // ===============================================
    // Data Management
    // ===============================================
    function loadData() {
      try {
        // Try to get data from localStorage
        const storedDrivers = localStorage.getItem('racingDashboard_drivers');
        const storedRaces = localStorage.getItem('racingDashboard_races');
        
        if (storedDrivers && storedRaces) {
          // Parse stored data
          drivers = JSON.parse(storedDrivers);
          races = JSON.parse(storedRaces);
        } else {
          // If no data in localStorage, use default data
          drivers = [...DEFAULT_DRIVERS];
          races = [...DEFAULT_RACES];
          
          // Store default data in localStorage
          localStorage.setItem('racingDashboard_drivers', JSON.stringify(drivers));
          localStorage.setItem('racingDashboard_races', JSON.stringify(races));
        }
        
        // Initialize participation object
        initParticipation();
        
        // Update UI
        updateUI();
        
        // Hide loading overlay
        hideLoading();
      } catch (error) {
        console.error('Error loading data:', error);
        
        // Fallback to default data if there was an error
        drivers = [...DEFAULT_DRIVERS];
        races = [...DEFAULT_RACES];
        
        // Update UI
        updateUI();
        
        // Hide loading overlay
        hideLoading();
      }
    }

    function saveData() {
      try {
        // Save data to localStorage
        localStorage.setItem('racingDashboard_drivers', JSON.stringify(drivers));
        localStorage.setItem('racingDashboard_races', JSON.stringify(races));
        
        // Update last update time
        lastUpdate = Date.now();
        updateLastUpdateTime();
      } catch (error) {
        console.error('Error saving data:', error);
        alert('There was an error saving the data. Please check the console for details.');
      }
    }

    function refreshData() {
      try {
        const storedDrivers = localStorage.getItem('racingDashboard_drivers');
        const storedRaces = localStorage.getItem('racingDashboard_races');
        
        if (storedDrivers && storedRaces) {
          drivers = JSON.parse(storedDrivers);
          races = JSON.parse(storedRaces);
          
          initParticipation();
          updateUI();
        }
        
        lastUpdate = Date.now();
        updateLastUpdateTime();
      } catch (error) {
        console.error('Error refreshing data:', error);
      }
    }

    function initParticipation() {
      participation = {};
      drivers.forEach(driver => {
        participation[driver.id] = true;
      });
    }

    // ===============================================
    // UI Updates
    // ===============================================
    function updateUI() {
      try {
        updateDriversCount();
        renderDriversTable();
        renderRacesList();
        updateLastUpdateTime();
        updateFormVisibility();
      } catch (error) {
        console.error('Error updating UI:', error);
      }
    }

    function updateDriversCount() {
      document.getElementById('driversCount').textContent = `${drivers.length} Drivers`;
    }

    function updateLastUpdateTime() {
      document.getElementById('lastUpdateTime').textContent = formatTime(lastUpdate);
    }

    function renderDriversTable() {
      const tableBody = document.getElementById('driversTableBody');
      tableBody.innerHTML = '';
      
      // Sort drivers
      const sortedDrivers = [...drivers].sort((a, b) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
      
      // Create table rows
      sortedDrivers.forEach((driver, index) => {
        const row = document.createElement('tr');
        
        // Calculate win percentage
        const winPercentage = driver.races > 0 ? (driver.wins / driver.races) * 100 : 0;
        
        // Car Number
        const carCell = document.createElement('td');
        carCell.innerHTML = `
          <div class="driver-circle" style="background-color: hsl(${driver.id * 137.5 % 360}, 70%, 50%)">
            ${driver.carNumber}
          </div>
        `;
        
        // Driver Name
        const nameCell = document.createElement('td');
        nameCell.style.fontWeight = 'bold';
        nameCell.textContent = driver.name;
        
        // Races
        const racesCell = document.createElement('td');
        racesCell.textContent = driver.races;
        
        // Wins
        const winsCell = document.createElement('td');
        winsCell.innerHTML = `<span class="badge badge-green">${driver.wins}</span>`;
        
        // Losses
        const lossesCell = document.createElement('td');
        lossesCell.innerHTML = `<span class="badge badge-red">${driver.losses}</span>`;
        
        // Win Percentage
        const percentCell = document.createElement('td');
        percentCell.innerHTML = `
          <div>
            <div class="progress-container">
              <div class="progress-bar" style="width: ${winPercentage}%; background-color: ${winPercentage > 50 ? '#10B981' : '#F59E0B'}"></div>
            </div>
            <span>${winPercentage.toFixed(1)}%</span>
          </div>
        `;
        
        // Actions (only for admin)
        const actionsCell = document.createElement('td');
        
        if (isAdmin) {
          actionsCell.innerHTML = `
            <div class="flex space-x-2">
              <button class="win-button btn-success" data-id="${driver.id}">Win</button>
              <button class="loss-button btn-danger" data-id="${driver.id}">Loss</button>
              <button class="edit-button btn-warning" data-id="${driver.id}">Edit</button>
              <button class="delete-button btn-danger" data-id="${driver.id}">Delete</button>
            </div>
          `;
        }
        
        // Add all cells to the row
        row.appendChild(carCell);
        row.appendChild(nameCell);
        row.appendChild(racesCell);
        row.appendChild(winsCell);
        row.appendChild(lossesCell);
        row.appendChild(percentCell);
        
        if (isAdmin) {
          row.appendChild(actionsCell);
        }
        
        // Add the row to the table
        tableBody.appendChild(row);
      });
      
      // Add event listeners to action buttons
      if (isAdmin) {
        document.querySelectorAll('.win-button').forEach(button => {
          button.addEventListener('click', () => addWin(parseInt(button.dataset.id)));
        });
        
        document.querySelectorAll('.loss-button').forEach(button => {
          button.addEventListener('click', () => addLoss(parseInt(button.dataset.id)));
        });
        
        document.querySelectorAll('.edit-button').forEach(button => {
          button.addEventListener('click', () => showEditDriverModal(parseInt(button.dataset.id)));
        });
        
        document.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', () => showDeleteConfirmModal('driver', parseInt(button.dataset.id)));
        });
      }
      
      // Show/hide actions column
      const actionsColumn = document.getElementById('actionsColumn');
      if (isAdmin) {
        actionsColumn.classList.remove('hidden');
      } else {
        actionsColumn.classList.add('hidden');
      }
    }

    function renderRacesList() {
      const racesList = document.getElementById('racesList');
      racesList.innerHTML = '';
      
      races.forEach(race => {
        const raceCard = document.createElement('div');
        raceCard.className = 'race-card';
        
        // Race header with name and date
        const raceHeader = document.createElement('div');
        raceHeader.className = 'race-header';
        raceHeader.innerHTML = `
          <h3>${race.name}</h3>
          <div>${formatDate(race.date)}</div>
        `;
        
        // Race content with results
        const raceContent = document.createElement('div');
        raceContent.className = 'race-content';
        
        // Create results table
        const resultsTable = document.createElement('table');
        resultsTable.innerHTML = `
          <thead>
            <tr>
              <th>Pos</th>
              <th>Car #</th>
              <th>Driver</th>
            </tr>
          </thead>
          <tbody>
            ${race.results
              .sort((a, b) => a.position - b.position)
              .map(result => `
                <tr>
                  <td>${result.position}</td>
                  <td>
                    <div class="driver-circle" style="background-color: hsl(${result.driverId * 137.5 % 360}, 70%, 50%)">
                      ${getDriverNumber(result.driverId)}
                    </div>
                  </td>
                  <td>${getDriverName(result.driverId)}</td>
                </tr>
              `).join('')}
          </tbody>
        `;
        
        raceContent.appendChild(resultsTable);
        
        // Add delete button for admin
        if (isAdmin) {
          const deleteButton = document.createElement('button');
          deleteButton.className = 'btn-danger mt-20';
          deleteButton.textContent = 'Delete Race';
          deleteButton.addEventListener('click', () => showDeleteConfirmModal('race', race.id));
          raceContent.appendChild(deleteButton);
        }
        
        // Add header and content to card
        raceCard.appendChild(raceHeader);
        raceCard.appendChild(raceContent);
        
        // Add card to list
        racesList.appendChild(raceCard);
      });
      
      // Update participation checkboxes if race form is visible
      if (!document.getElementById('addRaceForm').classList.contains('hidden')) {
        updateParticipationCheckboxes();
      }
    }

    function updateFormVisibility() {
      // Show/hide admin elements based on login state
      const addDriverButton = document.getElementById('addDriverButton');
      const addRaceButton = document.getElementById('addRaceButton');
      const adminBanner = document.getElementById('adminBanner');
      const viewModeInfo = document.getElementById('viewModeInfo');
      const raceViewModeInfo = document.getElementById('raceViewModeInfo');
      const loginButton = document.getElementById('loginButton');
      const logoutButton = document.getElementById('logoutButton');
      
      if (isAdmin) {
        addDriverButton.classList.remove('hidden');
        addRaceButton.classList.remove('hidden');
        adminBanner.style.display = 'block';
        viewModeInfo.classList.add('hidden');
        raceViewModeInfo.classList.add('hidden');
        loginButton.classList.add('hidden');
        logoutButton.classList.remove('hidden');
      } else {
        addDriverButton.classList.add('hidden');
        addRaceButton.classList.add('hidden');
        adminBanner.style.display = 'none';
        viewModeInfo.classList.remove('hidden');
        raceViewModeInfo.classList.remove('hidden');
        loginButton.classList.remove('hidden');
        logoutButton.classList.add('hidden');
      }
    }

    function updateParticipationCheckboxes() {
      const container = document.getElementById('driverParticipationContainer');
      container.innerHTML = '';
      
      drivers.forEach(driver => {
        const div = document.createElement('div');
        div.className = 'form-row';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `participate_${driver.id}`;
        checkbox.checked = participation[driver.id] || false;
        checkbox.addEventListener('change', () => {
          participation[driver.id] = checkbox.checked;
          updateDriverPositionInputs();
        });
        
        const label = document.createElement('label');
        label.htmlFor = `participate_${driver.id}`;
        label.textContent = `Car #${driver.carNumber} - ${driver.name}`;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
      
      // Update position inputs
      updateDriverPositionInputs();
    }

    function updateDriverPositionInputs() {
      const container = document.getElementById('driverPositionsContainer');
      container.innerHTML = '';
      
      drivers
        .filter(driver => participation[driver.id])
        .forEach(driver => {
          const div = document.createElement('div');
          div.className = 'form-row';
          
          const label = document.createElement('label');
          label.htmlFor = `position_${driver.id}`;
          label.textContent = `Car #${driver.carNumber} - ${driver.name}`;
          
          const input = document.createElement('input');
          input.type = 'number';
          input.id = `position_${driver.id}`;
          input.min = '1';
          input.placeholder = 'Position';
          
          div.appendChild(label);
          div.appendChild(input);
          container.appendChild(div);
        });
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // ===============================================
    // Event Handlers
    // ===============================================
    function switchTab(tab) {
      const driversTab = document.getElementById('driversTab');
      const racesTab = document.getElementById('racesTab');
      const driversContent = document.getElementById('driversContent');
      const racesContent = document.getElementById('racesContent');
      
      if (tab === 'drivers') {
        driversTab.classList.add('active');
        racesTab.classList.remove('active');
        
        driversContent.classList.add('active');
        driversContent.classList.remove('hidden');
        racesContent.classList.remove('active');
        racesContent.classList.add('hidden');
      } else {
        racesTab.classList.add('active');
        driversTab.classList.remove('active');
        
        racesContent.classList.add('active');
        racesContent.classList.remove('hidden');
        driversContent.classList.remove('active');
        driversContent.classList.add('hidden');
      }
    }

    function toggleAutoRefresh() {
      const checkbox = document.getElementById('autoRefreshToggle');
      autoRefresh = checkbox.checked;
      
      if (autoRefresh) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    }

    function startAutoRefresh() {
      // Only start auto-refresh if in view mode and auto-refresh is enabled
      if (!isAdmin && autoRefresh) {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
          refreshData();
        }, 10000); // Every 10 seconds
      }
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    function toggleAddDriverForm() {
      const form = document.getElementById('addDriverForm');
      form.classList.toggle('hidden');
      
      // Reset form fields
      if (!form.classList.contains('hidden')) {
        document.getElementById('newDriverName').value = '';
        document.getElementById('newDriverNumber').value = '';
        document.getElementById('newDriverWins').value = '0';
        document.getElementById('newDriverLosses').value = '0';
        document.getElementById('newDriverRaces').value = '0';
      }
    }

    function toggleAddRaceForm() {
      const form = document.getElementById('addRaceForm');
      form.classList.toggle('hidden');
      
      // Reset form fields and update participation if showing
      if (!form.classList.contains('hidden')) {
        document.getElementById('newRaceName').value = '';
        document.getElementById('newRaceDate').value = new Date().toISOString().split('T')[0];
        updateParticipationCheckboxes();
      }
    }

    function showLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('passwordInput').value = '';
      document.getElementById('loginError').classList.add('hidden');
      document.getElementById('passwordInput').focus();
    }

    function hideLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }

    function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      const errorElement = document.getElementById('loginError');
      
      if (password === 'Dbonations1') {
        isAdmin = true;
        updateFormVisibility();
        hideLoginModal();
        stopAutoRefresh(); // Stop auto-refresh in admin mode
        renderDriversTable(); // Re-render to show admin buttons
        renderRacesList(); // Re-render to show admin buttons
      } else {
        errorElement.textContent = 'Incorrect password';
        errorElement.classList.remove('hidden');
      }
    }

    function handleLogout() {
      isAdmin = false;
      updateFormVisibility();
      renderDriversTable(); // Re-render to hide admin buttons
      renderRacesList(); // Re-render to hide admin buttons
      startAutoRefresh(); // Re-start auto-refresh in view mode
      refreshData(); // Refresh once on logout
    }

    function showEditDriverModal(driverId) {
      // Find the driver
      const driver = drivers.find(d => d.id === driverId);
      
      if (driver) {
        editingDriverId = driverId;
        
        // Fill the form
        document.getElementById('editDriverName').value = driver.name;
        document.getElementById('editDriverNumber').value = driver.carNumber;
        document.getElementById('editDriverWins').value = driver.wins;
        document.getElementById('editDriverLosses').value = driver.losses;
        document.getElementById('editDriverRaces').value = driver.races;
        
        // Show the modal
        document.getElementById('editDriverModal').style.display = 'flex';
      }
    }

    function hideEditDriverModal() {
      document.getElementById('editDriverModal').style.display = 'none';
      editingDriverId = null;
    }

    function showDeleteConfirmModal(type, id) {
      deleteItem = { id, type };
      
      document.getElementById('deleteItemType').textContent = type;
      document.getElementById('deleteConfirmModal').style.display = 'flex';
    }

    function hideDeleteConfirmModal() {
      document.getElementById('deleteConfirmModal').style.display = 'none';
      deleteItem = { id: null, type: null };
    }

    function addDriver() {
      try {
        const name = document.getElementById('newDriverName').value;
        const carNumber = document.getElementById('newDriverNumber').value;
        const wins = document.getElementById('newDriverWins').value || 0;
        const losses = document.getElementById('newDriverLosses').value || 0;
        const races = document.getElementById('newDriverRaces').value || 0;
        
        if (!name || !carNumber) {
          alert("Name and car number are required!");
          return;
        }
        
        const id = drivers.length > 0 ? Math.max(...drivers.map(d => d.id)) + 1 : 1;
        
        const driverToAdd = {
          id,
          name,
          carNumber: Number(carNumber),
          wins: Number(wins),
          losses: Number(losses),
          races: Number(races)
        };
        
        drivers.push(driverToAdd);
        saveData();
        
        // Update participation
        participation[id] = true;
        
        // Hide form
        toggleAddDriverForm();
        
        // Update UI
        updateUI();
      } catch (error) {
        console.error('Error adding driver:', error);
        alert('There was an error adding the driver. Please check the console for details.');
      }
    }

    function addRace() {
      try {
        const name = document.getElementById('newRaceName').value;
        const date = document.getElementById('newRaceDate').value;
        
        if (!name || !date) {
          alert("Race name and date are required!");
          return;
        }
        
        const id = races.length > 0 ? Math.max(...races.map(r => r.id)) + 1 : 1;
        const results = [];
        
        // Process positions for participating drivers
        drivers
          .filter(driver => participation[driver.id])
          .forEach(driver => {
            const positionInput = document.getElementById(`position_${driver.id}`);
            if (positionInput && positionInput.value) {
              const position = parseInt(positionInput.value);
              if (!isNaN(position) && position > 0) {
                results.push({ driverId: driver.id, position });
              }
            }
          });
        
        // Update driver stats
        if (results.length > 0) {
          results.forEach(result => {
            const driverIndex = drivers.findIndex(d => d.id === result.driverId);
            
            if (driverIndex !== -1) {
              // Update stats
              drivers[driverIndex].races += 1;
              
              if (result.position === 1) {
                drivers[driverIndex].wins += 1;
              } else {
                drivers[driverIndex].losses += 1;
              }
            }
          });
        }
        
        // Add new race
        const raceToAdd = {
          id,
          name,
          date,
          results
        };
        
        races.push(raceToAdd);
        saveData();
        
        // Reset form and hide it
        toggleAddRaceForm();
        
        // Update UI
        updateUI();
      } catch (error) {
        console.error('Error adding race:', error);
        alert('There was an error adding the race. Please check the console for details.');
      }
    }

    function saveDriverEdit() {
      try {
        if (editingDriverId) {
          const driverIndex = drivers.findIndex(d => d.id === editingDriverId);
          
          if (driverIndex !== -1) {
            // Update driver data
            drivers[driverIndex].name = document.getElementById('editDriverName').value;
            drivers[driverIndex].carNumber = Number(document.getElementById('editDriverNumber').value);
            drivers[driverIndex].wins = Number(document.getElementById('editDriverWins').value);
            drivers[driverIndex].losses = Number(document.getElementById('editDriverLosses').value);
            drivers[driverIndex].races = Number(document.getElementById('editDriverRaces').value);
            
            // Save data
            saveData();
            
            // Update UI
            updateUI();
            
            // Hide modal
            hideEditDriverModal();
          }
        }
      } catch (error) {
        console.error('Error saving driver edit:', error);
        alert('There was an error saving the driver edit. Please check the console for details.');
      }
    }

    function confirmDelete() {
      try {
        if (deleteItem.id && deleteItem.type) {
          if (deleteItem.type === 'driver') {
            deleteDriver(deleteItem.id);
          } else if (deleteItem.type === 'race') {
            deleteRace(deleteItem.id);
          }
          
          // Hide modal
          hideDeleteConfirmModal();
        }
      } catch (error) {
        console.error('Error confirming delete:', error);
        alert('There was an error deleting the item. Please check the console for details.');
      }
    }

    function deleteDriver(id) {
      // Find the driver
      const driverIndex = drivers.findIndex(d => d.id === id);
      
      if (driverIndex !== -1) {
        // Remove the driver
        drivers.splice(driverIndex, 1);
        
        // Remove the driver from races
        races.forEach(race => {
          race.results = race.results.filter(r => r.driverId !== id);
        });
        
        // Save data
        saveData();
        
        // Update UI
        updateUI();
      }
    }

    function deleteRace(id) {
      // Find the race
      const raceIndex = races.findIndex(r => r.id === id);
      
      if (raceIndex !== -1) {
        const race = races[raceIndex];
        
        // Update driver stats
        race.results.forEach(result => {
          const driverIndex = drivers.findIndex(d => d.id === result.driverId);
          
          if (driverIndex !== -1) {
            // Update stats
            drivers[driverIndex].races = Math.max(0, drivers[driverIndex].races - 1);
            
            if (result.position === 1) {
              drivers[driverIndex].wins = Math.max(0, drivers[driverIndex].wins - 1);
            } else {
              drivers[driverIndex].losses = Math.max(0, drivers[driverIndex].losses - 1);
            }
          }
        });
        
        // Remove the race
        races.splice(raceIndex, 1);
        
        // Save data
        saveData();
        
        // Update UI
        updateUI();
      }
    }

    function addWin(id) {
      const driverIndex = drivers.findIndex(d => d.id === id);
      
      if (driverIndex !== -1) {
        drivers[driverIndex].wins += 1;
        drivers[driverIndex].races += 1;
        
        saveData();
        updateUI();
      }
    }

    function addLoss(id) {
      const driverIndex = drivers.findIndex(d => d.id === id);
      
      if (driverIndex !== -1) {
        drivers[driverIndex].losses += 1;
        drivers[driverIndex].races += 1;
        
        saveData();
        updateUI();
      }
    }

    function requestSort(key) {
      let direction = 'desc';
      if (sortConfig.key === key && sortConfig.direction === 'desc') {
        direction = 'asc';
      }
      
      sortConfig = { key, direction };
      renderDriversTable();
    }

    // ===============================================
    // Helper Functions
    // ===============================================
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString();
    }

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function getDriverName(id) {
      const driver = drivers.find(d => d.id === id);
      return driver ? driver.name : 'Unknown';
    }

    function getDriverNumber(id) {
      const driver = drivers.find(d => d.id === id);
      return driver ? driver.carNumber : 'N/A';
    }
  </script>
</body>
</html>